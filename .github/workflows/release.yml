name: Release to npm

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version type to bump (major, minor, or patch)'
        required: true
        type: choice
        options:
          - major
          - minor
          - patch

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: 'package.json'
          registry-url: 'https://registry.npmjs.org/'

      - name: Install dependencies
        run: npm ci

      - name: Install dependencies
        working-directory: ./packages/frontend
        run: npm ci

      - name: Update version
        run: |
          git config user.name "Yuji Ueki"
          git config user.email "unhappychoice@gmail.com"
          npm version ${{ github.event.inputs.version_type }}
          git push
          git push --tags

      - name: Update CHANGELOG
        run: |
          VERSION_TAG=$(git describe --tags --abbrev=0)
          ENTRY=$(bash scripts/generate-changelog.sh "$VERSION_TAG")
          TMPFILE=$(mktemp)
          echo "# Changelog" > "$TMPFILE"
          echo "" >> "$TMPFILE"
          echo "$ENTRY" >> "$TMPFILE"
          echo "" >> "$TMPFILE"
          tail -n +2 CHANGELOG.md >> "$TMPFILE"
          mv "$TMPFILE" CHANGELOG.md
          git add CHANGELOG.md
          git commit -m "docs: update CHANGELOG.md for ${VERSION_TAG}"
          git push

      - name: Build project
        run: npm run build

      - name: Build frontend
        run: npm run build:frontend

      - name: Publish to npm
        run: npx npm@11.5.1 publish
